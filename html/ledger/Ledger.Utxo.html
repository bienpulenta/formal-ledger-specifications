<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Utxo</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{UTxO}
\label{sec:utxo}

\subsection{Accounting}

</a><a id="59" class="Markup">\begin{code}[hide]</a>
<a id="78" class="Symbol">{-#</a> <a id="82" class="Keyword">OPTIONS</a> <a id="90" class="Pragma">--safe</a> <a id="97" class="Symbol">#-}</a>
<a id="101" class="Symbol">{-#</a> <a id="105" class="Keyword">OPTIONS</a> <a id="113" class="Pragma">--overlapping-instances</a> <a id="137" class="Symbol">#-}</a>

<a id="142" class="Keyword">open</a> <a id="147" class="Keyword">import</a> <a id="154" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>

<a id="174" class="Keyword">module</a> <a id="181" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="193" class="Symbol">(</a><a id="194" href="Ledger.Utxo.html#194" class="Bound">txs</a> <a id="198" class="Symbol">:</a> <a id="200" href="Ledger.Transaction.html#516" class="Record">TransactionStructure</a><a id="220" class="Symbol">)</a> <a id="222" class="Keyword">where</a>

<a id="229" class="Keyword">open</a> <a id="234" class="Keyword">import</a> <a id="241" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a> <a id="256" class="Keyword">hiding</a> <a id="263" class="Symbol">(</a><a id="264" href="Relation.Unary.html#3685" class="Function">Dec₁</a><a id="268" class="Symbol">)</a>

<a id="271" class="Keyword">open</a> <a id="276" class="Keyword">import</a> <a id="283" href="Algebra.html" class="Module">Algebra</a> <a id="291" class="Keyword">using</a> <a id="297" class="Symbol">(</a><a id="298" href="Algebra.Bundles.html#6578" class="Record">CommutativeMonoid</a><a id="315" class="Symbol">)</a>
<a id="317" class="Keyword">open</a> <a id="322" class="Keyword">import</a> <a id="329" href="Algebra.Structures.html" class="Module">Algebra.Structures</a>
<a id="348" class="Keyword">open</a> <a id="353" class="Keyword">import</a> <a id="360" href="Data.Nat.html" class="Module">Data.Nat</a> <a id="369" class="Keyword">using</a> <a id="375" class="Symbol">(</a><a id="376" href="Data.Nat.Properties.html#5872" class="Function Operator">_≤?_</a><a id="380" class="Symbol">;</a> <a id="382" href="Data.Nat.Base.html#1535" class="Datatype Operator">_≤_</a><a id="385" class="Symbol">)</a>
<a id="387" class="Keyword">open</a> <a id="392" class="Keyword">import</a> <a id="399" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="419" class="Keyword">using</a> <a id="425" class="Symbol">(</a><a id="426" href="Data.Nat.Properties.html#16466" class="Function">+-0-commutativeMonoid</a><a id="447" class="Symbol">)</a>
<a id="449" class="Keyword">open</a> <a id="454" class="Keyword">import</a> <a id="461" href="Interface.Decidable.Instance.html" class="Module">Interface.Decidable.Instance</a>

<a id="491" class="Keyword">open</a> <a id="496" href="Ledger.Transaction.html#516" class="Module">TransactionStructure</a> <a id="517" href="Ledger.Utxo.html#194" class="Bound">txs</a>
<a id="521" class="Keyword">open</a> <a id="526" href="Ledger.Transaction.html#3201" class="Module">TxBody</a>
<a id="533" class="Keyword">open</a> <a id="538" href="Ledger.Transaction.html#3622" class="Module">TxWitnesses</a>
<a id="550" class="Keyword">open</a> <a id="555" href="Ledger.Transaction.html#3718" class="Module">Tx</a>

<a id="559" class="Keyword">open</a> <a id="564" class="Keyword">import</a> <a id="571" href="Ledger.Crypto.html" class="Module">Ledger.Crypto</a>
<a id="585" class="Keyword">open</a> <a id="590" class="Keyword">import</a> <a id="597" href="Ledger.PPUp.html" class="Module">Ledger.PPUp</a>
<a id="609" class="Keyword">open</a> <a id="614" class="Keyword">import</a> <a id="621" href="Ledger.PParams.html" class="Module">Ledger.PParams</a> <a id="636" href="Ledger.Epoch.html#593" class="Function">Epoch</a>
<a id="642" class="Keyword">open</a> <a id="647" class="Keyword">import</a> <a id="654" href="Ledger.TokenAlgebra.html" class="Module">Ledger.TokenAlgebra</a> <a id="674" class="Keyword">using</a> <a id="680" class="Symbol">(</a><a id="681" href="Ledger.TokenAlgebra.html#299" class="Record">TokenAlgebra</a><a id="693" class="Symbol">)</a>

<a id="696" class="Keyword">open</a> <a id="701" class="Keyword">import</a> <a id="708" href="MyDebugOptions.html" class="Module">MyDebugOptions</a>
<a id="723" class="Comment">--open import Tactic.Defaults</a>
<a id="753" class="Keyword">open</a> <a id="758" class="Keyword">import</a> <a id="765" href="Tactic.DeriveComp.html" class="Module">Tactic.DeriveComp</a>

<a id="784" class="Keyword">instance</a>
  <a id="795" href="Ledger.Utxo.html#795" class="Function">_</a> <a id="797" class="Symbol">=</a> <a id="799" href="Interface.Decidable.Instance.html#766" class="Function">Decidable²⇒Dec</a> <a id="814" href="Data.Nat.Properties.html#5872" class="Function Operator">_≤?_</a>
  <a id="821" href="Ledger.Utxo.html#821" class="Function">_</a> <a id="823" class="Symbol">=</a> <a id="825" href="Ledger.TokenAlgebra.html#356" class="Field">TokenAlgebra.Value-CommutativeMonoid</a> <a id="862" href="Ledger.Transaction.html#2008" class="Field">tokenAlgebra</a>

<a id="876" class="Comment">-- utxoEntrySizeWithoutVal = 27 words (8 bytes)</a>
<a id="utxoEntrySizeWithoutVal"></a><a id="924" href="Ledger.Utxo.html#924" class="Function">utxoEntrySizeWithoutVal</a> <a id="948" class="Symbol">:</a> <a id="950" href="Ledger.TokenAlgebra.html#409" class="Function">MemoryEstimate</a>
<a id="965" href="Ledger.Utxo.html#924" class="Function">utxoEntrySizeWithoutVal</a> <a id="989" class="Symbol">=</a> <a id="991" class="Number">8</a>

<a id="utxoEntrySize"></a><a id="994" href="Ledger.Utxo.html#994" class="Function">utxoEntrySize</a> <a id="1008" class="Symbol">:</a> <a id="1010" href="Ledger.Transaction.html#2838" class="Function">TxOut</a> <a id="1016" class="Symbol">→</a> <a id="1018" href="Ledger.TokenAlgebra.html#409" class="Function">MemoryEstimate</a>
<a id="1033" href="Ledger.Utxo.html#994" class="Function">utxoEntrySize</a> <a id="1047" class="Symbol">(</a><a id="1048" href="Ledger.Utxo.html#1048" class="Bound">fst</a> <a id="1052" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="1054" href="Ledger.Utxo.html#1054" class="Bound">v</a><a id="1055" class="Symbol">)</a> <a id="1057" class="Symbol">=</a> <a id="1059" href="Ledger.Utxo.html#924" class="Function">utxoEntrySizeWithoutVal</a> <a id="1083" href="Agda.Builtin.Nat.html#319" class="Primitive Operator">+</a> <a id="1085" href="Ledger.TokenAlgebra.html#674" class="Function">size</a> <a id="1090" href="Ledger.Utxo.html#1054" class="Bound">v</a>

<a id="1093" class="Comment">-- TODO: fix this</a>
<a id="serSize"></a><a id="1111" href="Ledger.Utxo.html#1111" class="Function">serSize</a> <a id="1119" class="Symbol">:</a> <a id="1121" href="Ledger.TokenAlgebra.html#521" class="Function">Value</a> <a id="1127" class="Symbol">→</a> <a id="1129" href="Ledger.TokenAlgebra.html#409" class="Function">MemoryEstimate</a>
<a id="1144" href="Ledger.Utxo.html#1111" class="Function">serSize</a> <a id="1152" class="Symbol">=</a> <a id="1154" class="Symbol">λ</a> <a id="1156" href="Ledger.Utxo.html#1156" class="Bound">_</a> <a id="1158" class="Symbol">→</a> <a id="1160" href="Agda.Builtin.Nat.html#204" class="InductiveConstructor">zero</a>

<a id="1166" class="Markup">\end{code}</a><a id="1176" class="Background">

Figure~\ref{fig:functions:utxo} defines functions needed for the UTxO transition system.
Figure~\ref{fig:ts-types:utxo-shelley} defines the types needed for the UTxO transition system.
The UTxO transition system is given in Figure~\ref{fig:rules:utxo-shelley}.

\begin{itemize}

  \item
    The function $\fun{outs}$ creates the unspent outputs generated by a transaction.
    It maps the transaction id and output index to the output.

  \item
    The $\fun{balance}$ function calculates sum total of all the coin in a given UTxO.
\end{itemize}

\AgdaTarget{outs, minfee, inInterval, balance}
\begin{figure*}[h]
</a><a id="1791" class="Markup">\begin{code}</a>
<a id="outs"></a><a id="1804" href="Ledger.Utxo.html#1804" class="Function">outs</a> <a id="1809" class="Symbol">:</a> <a id="1811" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="1818" class="Symbol">→</a> <a id="1820" href="Ledger.Transaction.html#2861" class="Function">UTxO</a>
<a id="1825" href="Ledger.Utxo.html#1804" class="Function">outs</a> <a id="1830" href="Ledger.Utxo.html#1830" class="Bound">tx</a> <a id="1833" class="Symbol">=</a> <a id="1835" href="Axiom.Set.Map.html#4480" class="Function">mapKeys</a> <a id="1843" class="Symbol">(</a><a id="1844" href="Ledger.Transaction.html#3594" class="Field">txid</a> <a id="1849" href="Ledger.Utxo.html#1830" class="Bound">tx</a> <a id="1852" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,_</a><a id="1854" class="Symbol">)</a> <a id="1856" class="Symbol">(λ</a> <a id="1859" class="Keyword">where</a> <a id="1865" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="1870" class="Symbol">→</a> <a id="1872" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a><a id="1876" class="Symbol">)</a> <a id="1878" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="1880" href="Ledger.Transaction.html#3260" class="Field">txouts</a> <a id="1887" href="Ledger.Utxo.html#1830" class="Bound">tx</a>

<a id="balance"></a><a id="1891" href="Ledger.Utxo.html#1891" class="Function">balance</a> <a id="1899" class="Symbol">:</a> <a id="1901" href="Ledger.Transaction.html#2861" class="Function">UTxO</a> <a id="1906" class="Symbol">→</a> <a id="1908" href="Ledger.TokenAlgebra.html#521" class="Function">Value</a>
<a id="1914" href="Ledger.Utxo.html#1891" class="Function">balance</a> <a id="1922" href="Ledger.Utxo.html#1922" class="Bound">utxo</a> <a id="1927" class="Symbol">=</a> <a id="1929" href="Axiom.Set.Sum.html#3717" class="Function">Σᵐ[</a> <a id="1933" href="Ledger.Utxo.html#1933" class="Bound">x</a> <a id="1935" href="Axiom.Set.Sum.html#3717" class="Function">←</a> <a id="1937" href="Ledger.Utxo.html#1922" class="Bound">utxo</a> <a id="1942" href="Ledger.Prelude.html#2663" class="Function Operator">ᶠᵐ</a> <a id="1945" href="Axiom.Set.Sum.html#3717" class="Function">]</a> <a id="1947" href="Data.Product.Base.html#622" class="Field">proj₂</a> <a id="1953" class="Symbol">(</a><a id="1954" href="Data.Product.Base.html#622" class="Field">proj₂</a> <a id="1960" href="Ledger.Utxo.html#1933" class="Bound">x</a><a id="1961" class="Symbol">)</a>

<a id="cbalance"></a><a id="1964" href="Ledger.Utxo.html#1964" class="Function">cbalance</a> <a id="1973" class="Symbol">:</a> <a id="1975" href="Ledger.Transaction.html#2861" class="Function">UTxO</a> <a id="1980" class="Symbol">→</a> <a id="1982" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1987" href="Ledger.Utxo.html#1964" class="Function">cbalance</a> <a id="1996" href="Ledger.Utxo.html#1996" class="Bound">utxo</a> <a id="2001" class="Symbol">=</a> <a id="2003" href="Ledger.TokenAlgebra.html#572" class="Function">coin</a> <a id="2008" class="Symbol">(</a><a id="2009" href="Ledger.Utxo.html#1891" class="Function">balance</a> <a id="2017" href="Ledger.Utxo.html#1996" class="Bound">utxo</a><a id="2021" class="Symbol">)</a>

<a id="minfee"></a><a id="2024" href="Ledger.Utxo.html#2024" class="Function">minfee</a> <a id="2031" class="Symbol">:</a> <a id="2033" href="Ledger.PParams.html#211" class="Record">PParams</a> <a id="2041" class="Symbol">→</a> <a id="2043" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="2050" class="Symbol">→</a> <a id="2052" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="2057" href="Ledger.Utxo.html#2024" class="Function">minfee</a> <a id="2064" href="Ledger.Utxo.html#2064" class="Bound">pp</a> <a id="2067" href="Ledger.Utxo.html#2067" class="Bound">tx</a> <a id="2070" class="Symbol">=</a> <a id="2072" href="Ledger.PParams.html#239" class="Function">a</a> <a id="2074" href="Agda.Builtin.Nat.html#522" class="Primitive Operator">*</a> <a id="2076" href="Ledger.Transaction.html#3569" class="Field">txsize</a> <a id="2083" href="Ledger.Utxo.html#2067" class="Bound">tx</a> <a id="2086" href="Agda.Builtin.Nat.html#319" class="Primitive Operator">+</a> <a id="2088" href="Ledger.PParams.html#266" class="Function">b</a>
  <a id="2092" class="Keyword">where</a> <a id="2098" class="Keyword">open</a> <a id="2103" href="Ledger.PParams.html#211" class="Module">PParams</a> <a id="2111" href="Ledger.Utxo.html#2064" class="Bound">pp</a>

<a id="2115" class="Comment">-- need to add withdrawals to consumed</a>
<a id="consumed"></a><a id="2154" href="Ledger.Utxo.html#2154" class="Function">consumed</a> <a id="2163" class="Symbol">:</a> <a id="2165" href="Ledger.PParams.html#211" class="Record">PParams</a> <a id="2173" class="Symbol">→</a> <a id="2175" href="Ledger.Transaction.html#2861" class="Function">UTxO</a> <a id="2180" class="Symbol">→</a> <a id="2182" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="2189" class="Symbol">→</a> <a id="2191" href="Ledger.TokenAlgebra.html#521" class="Function">Value</a>
<a id="2197" href="Ledger.Utxo.html#2154" class="Function">consumed</a> <a id="2206" href="Ledger.Utxo.html#2206" class="Bound">pp</a> <a id="2209" href="Ledger.Utxo.html#2209" class="Bound">utxo</a> <a id="2214" href="Ledger.Utxo.html#2214" class="Bound">txb</a> <a id="2218" class="Symbol">=</a> <a id="2220" href="Ledger.Utxo.html#1891" class="Function">balance</a> <a id="2228" class="Symbol">(</a><a id="2229" href="Ledger.Utxo.html#2209" class="Bound">utxo</a> <a id="2234" href="Axiom.Set.Map.html#4882" class="Function Operator">∣</a> <a id="2236" href="Ledger.Transaction.html#3230" class="Field">txins</a> <a id="2242" href="Ledger.Utxo.html#2214" class="Bound">txb</a><a id="2245" class="Symbol">)</a>
                       <a id="2270" href="Ledger.TokenAlgebra.html#550" class="Function Operator">+ᵛ</a> <a id="2273" href="Ledger.Transaction.html#3328" class="Field">mint</a> <a id="2278" href="Ledger.Utxo.html#2214" class="Bound">txb</a>
                     <a id="2303" class="Comment">--+ inject (wbalance (txwdrls txb) + keyRefunds pp txb)</a>

<a id="2360" class="Comment">-- need to add deposits to produced</a>
<a id="produced"></a><a id="2396" href="Ledger.Utxo.html#2396" class="Function">produced</a> <a id="2405" class="Symbol">:</a> <a id="2407" href="Ledger.PParams.html#211" class="Record">PParams</a> <a id="2415" class="Symbol">→</a> <a id="2417" href="Ledger.Transaction.html#2861" class="Function">UTxO</a> <a id="2422" class="Symbol">→</a> <a id="2424" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="2431" class="Symbol">→</a>  <a id="2434" href="Ledger.TokenAlgebra.html#521" class="Function">Value</a>
<a id="2440" href="Ledger.Utxo.html#2396" class="Function">produced</a> <a id="2449" href="Ledger.Utxo.html#2449" class="Bound">pp</a> <a id="2452" href="Ledger.Utxo.html#2452" class="Bound">utxo</a> <a id="2457" href="Ledger.Utxo.html#2457" class="Bound">txb</a> <a id="2461" class="Symbol">=</a> <a id="2463" href="Ledger.Utxo.html#1891" class="Function">balance</a> <a id="2471" class="Symbol">(</a><a id="2472" href="Ledger.Utxo.html#1804" class="Function">outs</a> <a id="2477" href="Ledger.Utxo.html#2457" class="Bound">txb</a><a id="2480" class="Symbol">)</a>
                       <a id="2505" href="Ledger.TokenAlgebra.html#550" class="Function Operator">+ᵛ</a> <a id="2508" href="Ledger.TokenAlgebra.html#604" class="Function">inject</a> <a id="2515" class="Symbol">(</a><a id="2516" href="Ledger.Transaction.html#3357" class="Field">txfee</a> <a id="2522" href="Ledger.Utxo.html#2457" class="Bound">txb</a><a id="2525" class="Symbol">)</a>
                     <a id="2548" class="Comment">--+ totalDeposits pp stpools (txcerts txb))</a>

<a id="2593" class="Comment">-- this has to be a type definition for inference to work</a>
<a id="2651" class="Keyword">data</a> <a id="inInterval"></a><a id="2656" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="2667" class="Symbol">(</a><a id="2668" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2673" class="Symbol">:</a> <a id="2675" href="Ledger.Epoch.html#608" class="Function">Slot</a><a id="2679" class="Symbol">)</a> <a id="2681" class="Symbol">:</a> <a id="2683" class="Symbol">(</a><a id="2684" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="2690" href="Ledger.Epoch.html#608" class="Function">Slot</a> <a id="2695" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="2697" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="2703" href="Ledger.Epoch.html#608" class="Function">Slot</a><a id="2707" class="Symbol">)</a> <a id="2709" class="Symbol">→</a> <a id="2711" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="2715" class="Keyword">where</a>
  <a id="inInterval.both"></a><a id="2723" href="Ledger.Utxo.html#2723" class="InductiveConstructor">both</a>  <a id="2729" class="Symbol">:</a> <a id="2731" class="Symbol">∀</a> <a id="2733" class="Symbol">{</a><a id="2734" href="Ledger.Utxo.html#2734" class="Bound">l</a> <a id="2736" href="Ledger.Utxo.html#2736" class="Bound">r</a><a id="2737" class="Symbol">}</a> <a id="2739" class="Symbol">→</a> <a id="2741" href="Ledger.Utxo.html#2734" class="Bound">l</a> <a id="2743" href="Ledger.Epoch.html#892" class="Function Operator">≤ˢ</a> <a id="2746" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2751" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="2753" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2758" href="Ledger.Epoch.html#892" class="Function Operator">≤ˢ</a> <a id="2761" href="Ledger.Utxo.html#2736" class="Bound">r</a>  <a id="2764" class="Symbol">→</a>  <a id="2767" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="2778" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2783" class="Symbol">(</a><a id="2784" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="2789" href="Ledger.Utxo.html#2734" class="Bound">l</a>  <a id="2792" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2794" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="2799" href="Ledger.Utxo.html#2736" class="Bound">r</a><a id="2800" class="Symbol">)</a>
  <a id="inInterval.lower"></a><a id="2804" href="Ledger.Utxo.html#2804" class="InductiveConstructor">lower</a> <a id="2810" class="Symbol">:</a> <a id="2812" class="Symbol">∀</a> <a id="2814" class="Symbol">{</a><a id="2815" href="Ledger.Utxo.html#2815" class="Bound">l</a><a id="2816" class="Symbol">}</a>   <a id="2820" class="Symbol">→</a> <a id="2822" href="Ledger.Utxo.html#2815" class="Bound">l</a> <a id="2824" href="Ledger.Epoch.html#892" class="Function Operator">≤ˢ</a> <a id="2827" href="Ledger.Utxo.html#2668" class="Bound">slot</a>              <a id="2845" class="Symbol">→</a>  <a id="2848" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="2859" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2864" class="Symbol">(</a><a id="2865" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="2870" href="Ledger.Utxo.html#2815" class="Bound">l</a>  <a id="2873" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2875" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a><a id="2882" class="Symbol">)</a>
  <a id="inInterval.upper"></a><a id="2886" href="Ledger.Utxo.html#2886" class="InductiveConstructor">upper</a> <a id="2892" class="Symbol">:</a> <a id="2894" class="Symbol">∀</a> <a id="2896" class="Symbol">{</a><a id="2897" href="Ledger.Utxo.html#2897" class="Bound">r</a><a id="2898" class="Symbol">}</a>   <a id="2902" class="Symbol">→</a> <a id="2904" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2909" href="Ledger.Epoch.html#892" class="Function Operator">≤ˢ</a> <a id="2912" href="Ledger.Utxo.html#2897" class="Bound">r</a>              <a id="2927" class="Symbol">→</a>  <a id="2930" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="2941" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="2946" class="Symbol">(</a><a id="2947" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="2955" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2957" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="2962" href="Ledger.Utxo.html#2897" class="Bound">r</a><a id="2963" class="Symbol">)</a>
  <a id="inInterval.none"></a><a id="2967" href="Ledger.Utxo.html#2967" class="InductiveConstructor">none</a>  <a id="2973" class="Symbol">:</a>                                     <a id="3011" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="3022" href="Ledger.Utxo.html#2668" class="Bound">slot</a> <a id="3027" class="Symbol">(</a><a id="3028" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="3036" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="3038" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a><a id="3045" class="Symbol">)</a>

<a id="3048" class="Markup">\end{code}</a><a id="3058" class="Background">
</a><a id="3059" class="Markup">\begin{code}[hide]</a>
<a id="3078" class="Keyword">instance</a>
  <a id="HasCoin-UTxO"></a><a id="3089" href="Ledger.Utxo.html#3089" class="Function">HasCoin-UTxO</a> <a id="3102" class="Symbol">:</a> <a id="3104" href="Ledger.Interface.HasCoin.html#124" class="Record">HasCoin</a> <a id="3112" href="Ledger.Transaction.html#2861" class="Function">UTxO</a>
  <a id="3119" href="Ledger.Utxo.html#3089" class="Function">HasCoin-UTxO</a> <a id="3132" class="Symbol">.</a><a id="3133" href="Ledger.Interface.HasCoin.html#170" class="Field">getCoin</a> <a id="3141" class="Symbol">=</a> <a id="3143" href="Ledger.Utxo.html#1964" class="Function">cbalance</a>
<a id="3152" class="Markup">\end{code}</a><a id="3162" class="Background">

\caption{Functions used in UTxO rules}
\label{fig:functions:utxo}
\end{figure*}

\AgdaTarget{UTxOEnv, UTxOState, \_⊢\_⇀⦇\_,UTXO⦈\_}
\begin{figure*}[h]
\emph{UTxO environment}
</a><a id="3339" class="Markup">\begin{code}</a>
<a id="3352" class="Keyword">record</a> <a id="UTxOEnv"></a><a id="3359" href="Ledger.Utxo.html#3359" class="Record">UTxOEnv</a> <a id="3367" class="Symbol">:</a> <a id="3369" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="3373" class="Keyword">where</a>
  <a id="3381" class="Keyword">field</a> <a id="UTxOEnv.slot"></a><a id="3387" href="Ledger.Utxo.html#3387" class="Field">slot</a>    <a id="3395" class="Symbol">:</a> <a id="3397" href="Ledger.Epoch.html#608" class="Function">Slot</a>
        <a id="UTxOEnv.pparams"></a><a id="3410" href="Ledger.Utxo.html#3410" class="Field">pparams</a> <a id="3418" class="Symbol">:</a> <a id="3420" href="Ledger.PParams.html#211" class="Record">PParams</a>
<a id="3428" class="Markup">\end{code}</a><a id="3438" class="Background">
\emph{UTxO states}
</a><a id="3458" class="Markup">\begin{code}</a>
<a id="3471" class="Keyword">record</a> <a id="UTxOState"></a><a id="3478" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a> <a id="3488" class="Symbol">:</a> <a id="3490" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="3494" class="Keyword">where</a>
  <a id="3502" class="Keyword">constructor</a> <a id="⟦_,_⟧ᵘ"></a><a id="3514" href="Ledger.Utxo.html#3514" class="InductiveConstructor Operator">⟦_,_⟧ᵘ</a>
  <a id="3523" class="Keyword">field</a> <a id="UTxOState.utxo"></a><a id="3529" href="Ledger.Utxo.html#3529" class="Field">utxo</a> <a id="3534" class="Symbol">:</a> <a id="3536" href="Ledger.Transaction.html#2861" class="Function">UTxO</a>
        <a id="UTxOState.fees"></a><a id="3549" href="Ledger.Utxo.html#3549" class="Field">fees</a> <a id="3554" class="Symbol">:</a> <a id="3556" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="3561" class="Markup">\end{code}</a><a id="3571" class="Background">
\emph{UTxO transitions}

</a><a id="3597" class="Markup">\begin{code}[hide]</a>
<a id="3616" class="Keyword">private</a> <a id="3624" class="Keyword">variable</a>
  <a id="3635" href="Ledger.Utxo.html#3635" class="Generalizable">tx</a> <a id="3638" class="Symbol">:</a> <a id="3640" href="Ledger.Transaction.html#3201" class="Record">TxBody</a>
  <a id="3649" href="Ledger.Utxo.html#3649" class="Generalizable">utxo</a> <a id="3654" href="Ledger.Utxo.html#3654" class="Generalizable">utxo&#39;</a> <a id="3660" href="Ledger.Utxo.html#3660" class="Generalizable">utxo1</a> <a id="3666" href="Ledger.Utxo.html#3666" class="Generalizable">utxo2</a> <a id="3672" class="Symbol">:</a> <a id="3674" href="Ledger.Transaction.html#2861" class="Function">UTxO</a>
  <a id="3681" href="Ledger.Utxo.html#3681" class="Generalizable">fee</a> <a id="3685" href="Ledger.Utxo.html#3685" class="Generalizable">fee&#39;</a> <a id="3690" href="Ledger.Utxo.html#3690" class="Generalizable">fees</a> <a id="3695" href="Ledger.Utxo.html#3695" class="Generalizable">fees&#39;</a> <a id="3701" class="Symbol">:</a> <a id="3703" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
  <a id="3710" href="Ledger.Utxo.html#3710" class="Generalizable">utxoState</a> <a id="3720" href="Ledger.Utxo.html#3720" class="Generalizable">utxoState&#39;</a> <a id="3731" href="Ledger.Utxo.html#3731" class="Generalizable">utxoState1</a> <a id="3742" href="Ledger.Utxo.html#3742" class="Generalizable">utxoState2</a> <a id="3753" class="Symbol">:</a> <a id="3755" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a>
  <a id="3767" href="Ledger.Utxo.html#3767" class="Generalizable">Γ</a> <a id="3769" class="Symbol">:</a> <a id="3771" href="Ledger.Utxo.html#3359" class="Record">UTxOEnv</a>
  <a id="3781" href="Ledger.Utxo.html#3781" class="Generalizable">s</a> <a id="3783" href="Ledger.Utxo.html#3783" class="Generalizable">s&#39;</a> <a id="3786" class="Symbol">:</a> <a id="3788" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a>

<a id="⟦_⟧"></a><a id="3799" href="Ledger.Utxo.html#3799" class="Function Operator">⟦_⟧</a> <a id="3803" class="Symbol">:</a> <a id="3805" class="Symbol">{</a><a id="3806" href="Ledger.Utxo.html#3806" class="Bound">A</a> <a id="3808" class="Symbol">:</a> <a id="3810" href="Agda.Primitive.html#320" class="Primitive">Set</a><a id="3813" class="Symbol">}</a> <a id="3815" class="Symbol">→</a> <a id="3817" href="Ledger.Utxo.html#3806" class="Bound">A</a> <a id="3819" class="Symbol">→</a> <a id="3821" href="Ledger.Utxo.html#3806" class="Bound">A</a>
<a id="3823" href="Ledger.Utxo.html#3799" class="Function Operator">⟦_⟧</a> <a id="3827" class="Symbol">=</a> <a id="3829" href="Function.Base.html#695" class="Function">id</a>

<a id="3833" class="Keyword">instance</a>
  <a id="3844" href="Ledger.Utxo.html#3844" class="Function">_</a> <a id="3846" class="Symbol">=</a> <a id="3848" href="Ledger.Prelude.html#1656" class="Function">≟-∅</a>

  <a id="∈-inst"></a><a id="3855" href="Ledger.Utxo.html#3855" class="Function">∈-inst</a> <a id="3862" class="Symbol">:</a> <a id="3864" class="Symbol">∀</a> <a id="3866" class="Symbol">{</a><a id="3867" href="Ledger.Utxo.html#3867" class="Bound">A</a> <a id="3869" class="Symbol">:</a> <a id="3871" href="Agda.Primitive.html#320" class="Primitive">Set</a><a id="3874" class="Symbol">}</a> <a id="3876" class="Symbol">⦃</a> <a id="3878" href="Ledger.Utxo.html#3878" class="Bound">_</a> <a id="3880" class="Symbol">:</a> <a id="3882" href="Interface.DecEq.html#185" class="Record">DecEq</a> <a id="3888" href="Ledger.Utxo.html#3867" class="Bound">A</a> <a id="3890" class="Symbol">⦄</a> <a id="3892" class="Symbol">{</a><a id="3893" href="Ledger.Utxo.html#3893" class="Bound">s</a> <a id="3895" class="Symbol">:</a> <a id="3897" href="Ledger.Prelude.html#1236" class="Function Operator">ℙ</a> <a id="3899" href="Ledger.Utxo.html#3867" class="Bound">A</a><a id="3900" class="Symbol">}</a> <a id="3902" class="Symbol">→</a> <a id="3904" href="Interface.Decidable.Instance.html#499" class="Record">Dec₁</a> <a id="3909" class="Symbol">(</a><a id="3910" href="Axiom.Set.html#1496" class="Function Operator">_∈</a> <a id="3913" href="Ledger.Utxo.html#3893" class="Bound">s</a><a id="3914" class="Symbol">)</a>
  <a id="3918" href="Ledger.Utxo.html#3855" class="Function">∈-inst</a> <a id="3925" class="Symbol">{</a><a id="3926" class="Argument">s</a> <a id="3928" class="Symbol">=</a> <a id="3930" href="Ledger.Utxo.html#3930" class="Bound">s</a><a id="3931" class="Symbol">}</a> <a id="3933" class="Symbol">.</a><a id="3934" href="Interface.Decidable.Instance.html#564" class="Field">Dec₁.P?</a> <a id="3942" class="Symbol">=</a> <a id="3944" href="Axiom.Set.html#6479" class="Function Operator">_∈?</a> <a id="3948" href="Ledger.Utxo.html#3930" class="Bound">s</a>

  <a id="all?&#39;"></a><a id="3953" href="Ledger.Utxo.html#3953" class="Function">all?&#39;</a> <a id="3959" class="Symbol">:</a> <a id="3961" class="Symbol">∀</a> <a id="3963" class="Symbol">{</a><a id="3964" href="Ledger.Utxo.html#3964" class="Bound">A</a> <a id="3966" class="Symbol">:</a> <a id="3968" href="Agda.Primitive.html#320" class="Primitive">Set</a><a id="3971" class="Symbol">}</a> <a id="3973" class="Symbol">{</a><a id="3974" href="Ledger.Utxo.html#3974" class="Bound">P</a> <a id="3976" class="Symbol">:</a> <a id="3978" href="Ledger.Utxo.html#3964" class="Bound">A</a> <a id="3980" class="Symbol">→</a> <a id="3982" href="Agda.Primitive.html#320" class="Primitive">Set</a><a id="3985" class="Symbol">}</a> <a id="3987" class="Symbol">⦃</a> <a id="3989" href="Ledger.Utxo.html#3989" class="Bound">P?</a> <a id="3992" class="Symbol">:</a> <a id="3994" href="Interface.Decidable.Instance.html#499" class="Record">Dec₁</a> <a id="3999" href="Ledger.Utxo.html#3974" class="Bound">P</a> <a id="4001" class="Symbol">⦄</a> <a id="4003" class="Symbol">⦃</a> <a id="4005" href="Ledger.Utxo.html#4005" class="Bound">_</a> <a id="4007" class="Symbol">:</a> <a id="4009" href="Interface.DecEq.html#185" class="Record">DecEq</a> <a id="4015" href="Ledger.Utxo.html#3964" class="Bound">A</a> <a id="4017" class="Symbol">⦄</a> <a id="4019" class="Symbol">{</a><a id="4020" href="Ledger.Utxo.html#4020" class="Bound">s</a> <a id="4022" class="Symbol">:</a> <a id="4024" href="Ledger.Prelude.html#1236" class="Function Operator">ℙ</a> <a id="4026" href="Ledger.Utxo.html#3964" class="Bound">A</a><a id="4027" class="Symbol">}</a> <a id="4029" class="Symbol">→</a> <a id="4031" href="Relation.Nullary.Decidable.Core.html#1476" class="Record">Dec</a> <a id="4035" class="Symbol">(</a><a id="4036" href="Axiom.Set.html#5743" class="Function">All</a> <a id="4040" href="Ledger.Utxo.html#3974" class="Bound">P</a> <a id="4042" href="Ledger.Utxo.html#4020" class="Bound">s</a><a id="4043" class="Symbol">)</a>
  <a id="4047" href="Ledger.Utxo.html#3953" class="Function">all?&#39;</a> <a id="4053" class="Symbol">⦃</a> <a id="4055" class="Argument">P?</a> <a id="4058" class="Symbol">=</a> <a id="4060" class="Keyword">record</a> <a id="4067" class="Symbol">{</a> <a id="4069" href="Interface.Decidable.Instance.html#564" class="Field">P?</a> <a id="4072" class="Symbol">=</a> <a id="4074" href="Ledger.Utxo.html#4074" class="Bound">P?</a> <a id="4077" class="Symbol">}</a> <a id="4079" class="Symbol">⦄</a> <a id="4081" class="Symbol">{</a><a id="4082" href="Ledger.Utxo.html#4082" class="Bound">s</a><a id="4083" class="Symbol">}</a> <a id="4085" class="Symbol">=</a> <a id="4087" href="Axiom.Set.html#6527" class="Function">all?</a> <a id="4092" href="Ledger.Utxo.html#4074" class="Bound">P?</a>

  <a id="netId?"></a><a id="4098" href="Ledger.Utxo.html#4098" class="Function">netId?</a> <a id="4105" class="Symbol">:</a> <a id="4107" class="Symbol">∀</a> <a id="4109" class="Symbol">{</a><a id="4110" href="Ledger.Utxo.html#4110" class="Bound">A</a> <a id="4112" class="Symbol">:</a> <a id="4114" href="Agda.Primitive.html#320" class="Primitive">Set</a><a id="4117" class="Symbol">}</a> <a id="4119" class="Symbol">{</a><a id="4120" href="Ledger.Utxo.html#4120" class="Bound">networkId</a> <a id="4130" class="Symbol">:</a> <a id="4132" href="Ledger.Epoch.html#337" class="Function">Network</a><a id="4139" class="Symbol">}</a> <a id="4141" class="Symbol">{</a><a id="4142" href="Ledger.Utxo.html#4142" class="Bound">f</a> <a id="4144" class="Symbol">:</a> <a id="4146" href="Ledger.Utxo.html#4110" class="Bound">A</a> <a id="4148" class="Symbol">→</a> <a id="4150" href="Ledger.Epoch.html#337" class="Function">Network</a><a id="4157" class="Symbol">}</a> <a id="4159" class="Symbol">→</a> <a id="4161" href="Interface.Decidable.Instance.html#499" class="Record">Dec₁</a> <a id="4166" class="Symbol">(λ</a> <a id="4169" href="Ledger.Utxo.html#4169" class="Bound">a</a> <a id="4171" class="Symbol">→</a> <a id="4173" href="Ledger.Utxo.html#4142" class="Bound">f</a> <a id="4175" href="Ledger.Utxo.html#4169" class="Bound">a</a> <a id="4177" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="4179" href="Ledger.Utxo.html#4120" class="Bound">networkId</a><a id="4188" class="Symbol">)</a>
  <a id="4192" href="Ledger.Utxo.html#4098" class="Function">netId?</a> <a id="4199" class="Symbol">{_}</a> <a id="4203" class="Symbol">{</a><a id="4204" href="Ledger.Utxo.html#4204" class="Bound">networkId</a><a id="4213" class="Symbol">}</a> <a id="4215" class="Symbol">{</a><a id="4216" href="Ledger.Utxo.html#4216" class="Bound">f</a><a id="4217" class="Symbol">}</a> <a id="4219" class="Symbol">.</a><a id="4220" href="Interface.Decidable.Instance.html#564" class="Field">Dec₁.P?</a> <a id="4228" href="Ledger.Utxo.html#4228" class="Bound">a</a> <a id="4230" class="Symbol">=</a> <a id="4232" href="Ledger.Utxo.html#4216" class="Bound">f</a> <a id="4234" href="Ledger.Utxo.html#4228" class="Bound">a</a> <a id="4236" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="4238" href="Ledger.Utxo.html#4204" class="Bound">networkId</a>

  <a id="Dec-inInterval"></a><a id="4251" href="Ledger.Utxo.html#4251" class="Function">Dec-inInterval</a> <a id="4266" class="Symbol">:</a> <a id="4268" class="Symbol">{</a><a id="4269" href="Ledger.Utxo.html#4269" class="Bound">slot</a> <a id="4274" class="Symbol">:</a> <a id="4276" href="Ledger.Epoch.html#608" class="Function">Slot</a><a id="4280" class="Symbol">}</a> <a id="4282" class="Symbol">{</a><a id="4283" href="Ledger.Utxo.html#4283" class="Bound">I</a> <a id="4285" class="Symbol">:</a> <a id="4287" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="4293" href="Ledger.Epoch.html#608" class="Function">Slot</a> <a id="4298" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="4300" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="4306" href="Ledger.Epoch.html#608" class="Function">Slot</a><a id="4310" class="Symbol">}</a> <a id="4312" class="Symbol">→</a> <a id="4314" href="Relation.Nullary.Decidable.Core.html#1476" class="Record">Dec</a> <a id="4318" class="Symbol">(</a><a id="4319" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="4330" href="Ledger.Utxo.html#4269" class="Bound">slot</a> <a id="4335" href="Ledger.Utxo.html#4283" class="Bound">I</a><a id="4336" class="Symbol">)</a>
  <a id="4340" href="Ledger.Utxo.html#4251" class="Function">Dec-inInterval</a> <a id="4355" class="Symbol">{</a><a id="4356" href="Ledger.Utxo.html#4356" class="Bound">slot</a><a id="4360" class="Symbol">}</a> <a id="4362" class="Symbol">{</a><a id="4363" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="4368" href="Ledger.Utxo.html#4368" class="Bound">x</a>  <a id="4371" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4373" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="4378" href="Ledger.Utxo.html#4378" class="Bound">y</a> <a id="4380" class="Symbol">}</a> <a id="4382" class="Keyword">with</a> <a id="4387" href="Ledger.Utxo.html#4368" class="Bound">x</a> <a id="4389" href="Ledger.Epoch.html#1016" class="Function Operator">≤ˢ?</a> <a id="4393" href="Ledger.Utxo.html#4356" class="Bound">slot</a> <a id="4398" class="Symbol">|</a> <a id="4400" href="Ledger.Utxo.html#4356" class="Bound">slot</a> <a id="4405" href="Ledger.Epoch.html#1016" class="Function Operator">≤ˢ?</a> <a id="4409" href="Ledger.Utxo.html#4378" class="Bound">y</a>
  <a id="4413" class="Symbol">...</a> <a id="4417" class="Symbol">|</a> <a id="4419" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4422" href="Ledger.Utxo.html#4422" class="Bound">¬p₁</a> <a id="4426" class="Symbol">|</a> <a id="4428" class="Symbol">_</a>      <a id="4435" class="Symbol">=</a> <a id="4437" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4440" class="Symbol">λ</a> <a id="4442" class="Keyword">where</a> <a id="4448" class="Symbol">(</a><a id="4449" href="Ledger.Utxo.html#2723" class="InductiveConstructor">both</a> <a id="4454" class="Symbol">(</a><a id="4455" href="Ledger.Utxo.html#4455" class="Bound">h₁</a> <a id="4458" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4460" href="Ledger.Utxo.html#4460" class="Bound">h₂</a><a id="4462" class="Symbol">))</a> <a id="4465" class="Symbol">→</a> <a id="4467" href="Ledger.Utxo.html#4422" class="Bound">¬p₁</a> <a id="4471" href="Ledger.Utxo.html#4455" class="Bound">h₁</a>
  <a id="4476" class="Symbol">...</a> <a id="4480" class="Symbol">|</a> <a id="4482" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4486" href="Ledger.Utxo.html#4486" class="Bound">p₁</a> <a id="4489" class="Symbol">|</a> <a id="4491" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4494" href="Ledger.Utxo.html#4494" class="Bound">¬p₂</a> <a id="4498" class="Symbol">=</a> <a id="4500" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4503" class="Symbol">λ</a> <a id="4505" class="Keyword">where</a> <a id="4511" class="Symbol">(</a><a id="4512" href="Ledger.Utxo.html#2723" class="InductiveConstructor">both</a> <a id="4517" class="Symbol">(</a><a id="4518" href="Ledger.Utxo.html#4518" class="Bound">h₁</a> <a id="4521" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4523" href="Ledger.Utxo.html#4523" class="Bound">h₂</a><a id="4525" class="Symbol">))</a> <a id="4528" class="Symbol">→</a> <a id="4530" href="Ledger.Utxo.html#4494" class="Bound">¬p₂</a> <a id="4534" href="Ledger.Utxo.html#4523" class="Bound">h₂</a>
  <a id="4539" class="Symbol">...</a> <a id="4543" class="Symbol">|</a> <a id="4545" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4549" href="Ledger.Utxo.html#4549" class="Bound">p₁</a> <a id="4552" class="Symbol">|</a> <a id="4554" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4558" href="Ledger.Utxo.html#4558" class="Bound">p₂</a> <a id="4561" class="Symbol">=</a> <a id="4563" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4567" class="Symbol">(</a><a id="4568" href="Ledger.Utxo.html#2723" class="InductiveConstructor">both</a> <a id="4573" class="Symbol">(</a><a id="4574" href="Ledger.Utxo.html#4549" class="Bound">p₁</a> <a id="4577" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4579" href="Ledger.Utxo.html#4558" class="Bound">p₂</a><a id="4581" class="Symbol">))</a>
  <a id="4586" href="Ledger.Utxo.html#4251" class="Function">Dec-inInterval</a> <a id="4601" class="Symbol">{</a><a id="4602" href="Ledger.Utxo.html#4602" class="Bound">slot</a><a id="4606" class="Symbol">}</a> <a id="4608" class="Symbol">{</a><a id="4609" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="4614" href="Ledger.Utxo.html#4614" class="Bound">x</a>  <a id="4617" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4619" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a><a id="4626" class="Symbol">}</a> <a id="4628" class="Keyword">with</a> <a id="4633" href="Ledger.Utxo.html#4614" class="Bound">x</a> <a id="4635" href="Ledger.Epoch.html#1016" class="Function Operator">≤ˢ?</a> <a id="4639" href="Ledger.Utxo.html#4602" class="Bound">slot</a>
  <a id="4646" class="Symbol">...</a> <a id="4650" class="Symbol">|</a> <a id="4652" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4655" href="Ledger.Utxo.html#4655" class="Bound">¬p</a> <a id="4658" class="Symbol">=</a> <a id="4660" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a>  <a id="4664" class="Symbol">(λ</a> <a id="4667" class="Keyword">where</a> <a id="4673" class="Symbol">(</a><a id="4674" href="Ledger.Utxo.html#2804" class="InductiveConstructor">lower</a> <a id="4680" href="Ledger.Utxo.html#4680" class="Bound">h</a><a id="4681" class="Symbol">)</a> <a id="4683" class="Symbol">→</a> <a id="4685" href="Ledger.Utxo.html#4655" class="Bound">¬p</a> <a id="4688" href="Ledger.Utxo.html#4680" class="Bound">h</a><a id="4689" class="Symbol">)</a>
  <a id="4693" class="Symbol">...</a> <a id="4697" class="Symbol">|</a> <a id="4699" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4703" href="Ledger.Utxo.html#4703" class="Bound">p</a> <a id="4705" class="Symbol">=</a> <a id="4707" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4711" class="Symbol">(</a><a id="4712" href="Ledger.Utxo.html#2804" class="InductiveConstructor">lower</a> <a id="4718" href="Ledger.Utxo.html#4703" class="Bound">p</a><a id="4719" class="Symbol">)</a>
  <a id="4723" href="Ledger.Utxo.html#4251" class="Function">Dec-inInterval</a> <a id="4738" class="Symbol">{</a><a id="4739" href="Ledger.Utxo.html#4739" class="Bound">slot</a><a id="4743" class="Symbol">}</a> <a id="4745" class="Symbol">{</a><a id="4746" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="4754" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4756" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="4761" href="Ledger.Utxo.html#4761" class="Bound">x</a> <a id="4763" class="Symbol">}</a> <a id="4765" class="Keyword">with</a> <a id="4770" href="Ledger.Utxo.html#4739" class="Bound">slot</a> <a id="4775" href="Ledger.Epoch.html#1016" class="Function Operator">≤ˢ?</a> <a id="4779" href="Ledger.Utxo.html#4761" class="Bound">x</a>
  <a id="4783" class="Symbol">...</a> <a id="4787" class="Symbol">|</a> <a id="4789" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4792" href="Ledger.Utxo.html#4792" class="Bound">¬p</a> <a id="4795" class="Symbol">=</a> <a id="4797" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a>  <a id="4801" class="Symbol">(λ</a> <a id="4804" class="Keyword">where</a> <a id="4810" class="Symbol">(</a><a id="4811" href="Ledger.Utxo.html#2886" class="InductiveConstructor">upper</a> <a id="4817" href="Ledger.Utxo.html#4817" class="Bound">h</a><a id="4818" class="Symbol">)</a> <a id="4820" class="Symbol">→</a> <a id="4822" href="Ledger.Utxo.html#4792" class="Bound">¬p</a> <a id="4825" href="Ledger.Utxo.html#4817" class="Bound">h</a><a id="4826" class="Symbol">)</a>
  <a id="4830" class="Symbol">...</a> <a id="4834" class="Symbol">|</a> <a id="4836" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4840" href="Ledger.Utxo.html#4840" class="Bound">p</a> <a id="4842" class="Symbol">=</a> <a id="4844" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4848" class="Symbol">(</a><a id="4849" href="Ledger.Utxo.html#2886" class="InductiveConstructor">upper</a> <a id="4855" href="Ledger.Utxo.html#4840" class="Bound">p</a><a id="4856" class="Symbol">)</a>
  <a id="4860" href="Ledger.Utxo.html#4251" class="Function">Dec-inInterval</a> <a id="4875" class="Symbol">{</a><a id="4876" href="Ledger.Utxo.html#4876" class="Bound">slot</a><a id="4880" class="Symbol">}</a> <a id="4882" class="Symbol">{</a><a id="4883" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="4891" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4893" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a><a id="4900" class="Symbol">}</a> <a id="4902" class="Symbol">=</a> <a id="4904" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4908" href="Ledger.Utxo.html#2967" class="InductiveConstructor">none</a>

  <a id="HasCoin-UTxOState"></a><a id="4916" href="Ledger.Utxo.html#4916" class="Function">HasCoin-UTxOState</a> <a id="4934" class="Symbol">:</a> <a id="4936" href="Ledger.Interface.HasCoin.html#124" class="Record">HasCoin</a> <a id="4944" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a>
  <a id="4956" href="Ledger.Utxo.html#4916" class="Function">HasCoin-UTxOState</a> <a id="4974" class="Symbol">.</a><a id="4975" href="Ledger.Interface.HasCoin.html#170" class="Field">getCoin</a> <a id="4983" href="Ledger.Utxo.html#4983" class="Bound">s</a> <a id="4985" class="Symbol">=</a> <a id="4987" href="Ledger.Interface.HasCoin.html#170" class="Field">getCoin</a> <a id="4995" class="Symbol">(</a><a id="4996" href="Ledger.Utxo.html#3529" class="Field">UTxOState.utxo</a> <a id="5011" href="Ledger.Utxo.html#4983" class="Bound">s</a><a id="5012" class="Symbol">)</a> <a id="5014" href="Agda.Builtin.Nat.html#319" class="Primitive Operator">+</a> <a id="5016" class="Symbol">(</a><a id="5017" href="Ledger.Utxo.html#3549" class="Field">UTxOState.fees</a> <a id="5032" href="Ledger.Utxo.html#4983" class="Bound">s</a><a id="5033" class="Symbol">)</a>
<a id="5035" class="Keyword">data</a>
<a id="5040" class="Markup">\end{code}</a><a id="5050" class="Background">
</a><a id="5051" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,UTXO⦈_"></a><a id="5066" href="Ledger.Utxo.html#5066" class="Datatype Operator">_⊢_⇀⦇_,UTXO⦈_</a> <a id="5080" class="Symbol">:</a> <a id="5082" href="Ledger.Utxo.html#3359" class="Record">UTxOEnv</a> <a id="5090" class="Symbol">→</a> <a id="5092" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a> <a id="5102" class="Symbol">→</a> <a id="5104" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="5111" class="Symbol">→</a> <a id="5113" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a> <a id="5123" class="Symbol">→</a> <a id="5125" href="Agda.Primitive.html#320" class="Primitive">Set</a>
<a id="5129" class="Markup">\end{code}</a><a id="5139" class="Background">
\caption{UTxO transition-system types}
\label{fig:ts-types:utxo-shelley}
\end{figure*}

\begin{figure*}[h]
</a><a id="5247" class="Markup">\begin{code}[hide]</a>
<a id="5266" class="Keyword">data</a> <a id="5271" href="Ledger.Utxo.html#5066" class="Datatype Operator">_⊢_⇀⦇_,UTXO⦈_</a> <a id="5285" class="Keyword">where</a>
<a id="5291" class="Markup">\end{code}</a><a id="5301" class="Background">
</a><a id="5302" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,UTXO⦈_.UTXO-inductive"></a><a id="5317" href="Ledger.Utxo.html#5317" class="InductiveConstructor">UTXO-inductive</a> <a id="5332" class="Symbol">:</a>
    <a id="5338" class="Symbol">∀</a> <a id="5340" class="Symbol">{</a><a id="5341" href="Ledger.Utxo.html#5341" class="Bound">Γ</a><a id="5342" class="Symbol">}</a> <a id="5344" class="Symbol">{</a><a id="5345" href="Ledger.Utxo.html#5345" class="Bound">s</a><a id="5346" class="Symbol">}</a> <a id="5348" class="Symbol">{</a><a id="5349" href="Ledger.Utxo.html#5349" class="Bound">tx</a><a id="5351" class="Symbol">}</a>
    <a id="5357" class="Symbol">→</a> <a id="5359" class="Keyword">let</a> <a id="5363" href="Ledger.Utxo.html#5363" class="Bound">slot</a> <a id="5368" class="Symbol">=</a> <a id="5370" href="Ledger.Utxo.html#3387" class="Field">UTxOEnv.slot</a> <a id="5383" href="Ledger.Utxo.html#5341" class="Bound">Γ</a>
          <a id="5395" href="Ledger.Utxo.html#5395" class="Bound">pp</a>   <a id="5400" class="Symbol">=</a> <a id="5402" href="Ledger.Utxo.html#3410" class="Field">UTxOEnv.pparams</a> <a id="5418" href="Ledger.Utxo.html#5341" class="Bound">Γ</a>
          <a id="5430" href="Ledger.Utxo.html#5430" class="Bound">utxo</a> <a id="5435" class="Symbol">=</a> <a id="5437" href="Ledger.Utxo.html#3529" class="Field">UTxOState.utxo</a> <a id="5452" href="Ledger.Utxo.html#5345" class="Bound">s</a>
          <a id="5464" href="Ledger.Utxo.html#5464" class="Bound">fees</a> <a id="5469" class="Symbol">=</a> <a id="5471" href="Ledger.Utxo.html#3549" class="Field">UTxOState.fees</a> <a id="5486" href="Ledger.Utxo.html#5345" class="Bound">s</a>
      <a id="5494" class="Keyword">in</a>
    <a id="5501" href="Ledger.Transaction.html#3230" class="Field">txins</a> <a id="5507" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="5510" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="5512" href="Axiom.Set.html#4353" class="Function">∅</a>
    <a id="5518" class="Symbol">→</a> <a id="5520" href="Ledger.Utxo.html#2656" class="Datatype">inInterval</a> <a id="5531" href="Ledger.Utxo.html#5363" class="Bound">slot</a> <a id="5536" class="Symbol">(</a><a id="5537" href="Ledger.Transaction.html#3385" class="Field">txvldt</a> <a id="5544" href="Ledger.Utxo.html#5349" class="Bound">tx</a><a id="5546" class="Symbol">)</a>
    <a id="5552" class="Symbol">→</a> <a id="5554" href="Ledger.Transaction.html#3230" class="Field">txins</a> <a id="5560" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="5563" href="Axiom.Set.html#1579" class="Function Operator">⊆</a> <a id="5565" href="Axiom.Set.Rel.html#1257" class="Function">dom</a> <a id="5569" class="Symbol">(</a><a id="5570" href="Ledger.Utxo.html#5430" class="Bound">utxo</a> <a id="5575" href="Axiom.Set.Map.html#1686" class="Function Operator">ˢ</a><a id="5576" class="Symbol">)</a>
    <a id="5582" class="Symbol">→</a> <a id="5584" class="Keyword">let</a> <a id="5588" href="Ledger.Utxo.html#5588" class="Bound">f</a> <a id="5590" class="Symbol">=</a> <a id="5592" href="Ledger.Transaction.html#3357" class="Field">txfee</a> <a id="5598" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="5601" class="Keyword">in</a> <a id="5604" href="Ledger.Utxo.html#2024" class="Function">minfee</a> <a id="5611" href="Ledger.Utxo.html#5395" class="Bound">pp</a> <a id="5614" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="5617" href="Data.Nat.Base.html#1535" class="Datatype Operator">≤</a> <a id="5619" href="Ledger.Utxo.html#5588" class="Bound">f</a>
    <a id="5625" class="Symbol">→</a> <a id="5627" href="Ledger.Utxo.html#2154" class="Function">consumed</a> <a id="5636" href="Ledger.Utxo.html#5395" class="Bound">pp</a> <a id="5639" href="Ledger.Utxo.html#5430" class="Bound">utxo</a> <a id="5644" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="5647" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="5649" href="Ledger.Utxo.html#2396" class="Function">produced</a> <a id="5658" href="Ledger.Utxo.html#5395" class="Bound">pp</a> <a id="5661" href="Ledger.Utxo.html#5430" class="Bound">utxo</a> <a id="5666" href="Ledger.Utxo.html#5349" class="Bound">tx</a>
    <a id="5673" class="Symbol">→</a> <a id="5675" href="Ledger.TokenAlgebra.html#572" class="Function">coin</a> <a id="5680" class="Symbol">(</a><a id="5681" href="Ledger.Transaction.html#3328" class="Field">mint</a> <a id="5686" href="Ledger.Utxo.html#5349" class="Bound">tx</a><a id="5688" class="Symbol">)</a> <a id="5690" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="5692" class="Number">0</a>

<a id="5695" class="Comment">{- these break deriveComputational but don&#39;t matter at the moment
    → ∀ txout → txout ∈ proj₁ (txouts tx)
              → (getValue (proj₂ txout)) ≥ᵗ (inject (utxoEntrySize (proj₂ txout) * PParams.minUtxOValue pp))

    → ∀ txout → txout ∈ proj₁ (txouts tx)
              → (serSize (getValue (proj₂ txout))) ≤ PParams.maxValSize pp
-}</a>

    <a id="6038" class="Comment">-- PPUP</a>
    <a id="6050" class="Comment">-- these fail with some reduceDec error</a>
    <a id="6094" class="Comment">-- → All (λ { (inj₂ a , _) → BootstrapAddr.attrsSize a ≤ 64 ; _ → ⊤ }) (range ((txouts tx) ˢ))</a>
    <a id="6193" class="Comment">-- → All (λ a → netId (proj₁ a) ≡ networkId) (range ((txouts tx) ˢ))</a>
    <a id="6266" class="Comment">-- → All (λ a → RwdAddr.net a ≡ networkId) (dom ((txwdrls tx) ˢ))</a>
    <a id="6336" class="Symbol">→</a> <a id="6338" href="Ledger.Transaction.html#3569" class="Field">txsize</a> <a id="6345" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="6348" href="Data.Nat.Base.html#1535" class="Datatype Operator">≤</a> <a id="6350" href="Ledger.PParams.html#320" class="Field">PParams.maxTxSize</a> <a id="6368" href="Ledger.Utxo.html#5395" class="Bound">pp</a>
    <a id="6375" class="Comment">-- Add Deposits</a>
    <a id="6395" href="Interface.ComputationalRelation.html#276" class="Function Operator">────────────────────────────────</a>
    <a id="6432" href="Ledger.Utxo.html#5341" class="Bound">Γ</a>
      <a id="6440" href="Ledger.Utxo.html#5066" class="Datatype Operator">⊢</a> <a id="6442" href="Ledger.Utxo.html#5345" class="Bound">s</a>
      <a id="6450" href="Ledger.Utxo.html#5066" class="Datatype Operator">⇀⦇</a> <a id="6453" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="6456" href="Ledger.Utxo.html#5066" class="Datatype Operator">,UTXO⦈</a>
      <a id="6469" href="Ledger.Utxo.html#3514" class="InductiveConstructor Operator">⟦</a> <a id="6471" class="Symbol">(</a><a id="6472" href="Ledger.Utxo.html#5430" class="Bound">utxo</a> <a id="6477" href="Axiom.Set.Map.html#4952" class="Function Operator">∣</a> <a id="6479" href="Ledger.Transaction.html#3230" class="Field">txins</a> <a id="6485" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="6488" href="Axiom.Set.Map.html#4952" class="Function Operator">ᶜ</a><a id="6489" class="Symbol">)</a> <a id="6491" href="Axiom.Set.Map.html#3788" class="Function Operator">∪ᵐˡ</a> <a id="6495" href="Ledger.Utxo.html#1804" class="Function">outs</a> <a id="6500" href="Ledger.Utxo.html#5349" class="Bound">tx</a> <a id="6503" href="Ledger.Utxo.html#3514" class="InductiveConstructor Operator">,</a> <a id="6505" href="Ledger.Utxo.html#5464" class="Bound">fees</a> <a id="6510" href="Agda.Builtin.Nat.html#319" class="Primitive Operator">+</a> <a id="6512" href="Ledger.Utxo.html#5588" class="Bound">f</a> <a id="6514" href="Ledger.Utxo.html#3514" class="InductiveConstructor Operator">⟧ᵘ</a>
<a id="6517" class="Markup">\end{code}</a><a id="6527" class="Background">
</a><a id="6528" class="Markup">\begin{code}[hide]</a>
<a id="6547" class="Comment">-- TODO: This can&#39;t be moved into Properties because it breaks. Move</a>
<a id="6616" class="Comment">-- this once this is fixed.</a>
<a id="6644" class="Keyword">unquoteDecl</a> <a id="Computational-UTXO"></a><a id="6656" href="Ledger.Utxo.html#6656" class="Function">Computational-UTXO</a> <a id="6675" class="Symbol">=</a> <a id="6677" href="Tactic.DeriveComp.html#5646" class="Function">deriveComputational</a> <a id="6697" class="Symbol">(</a><a id="6698" class="Keyword">quote</a> <a id="6704" href="Ledger.Utxo.html#5066" class="Datatype Operator">_⊢_⇀⦇_,UTXO⦈_</a><a id="6717" class="Symbol">)</a> <a id="6719" href="Ledger.Utxo.html#6656" class="Function">Computational-UTXO</a>
<a id="6738" class="Markup">\end{code}</a><a id="6748" class="Background">
\caption{UTXO inference rules}
\label{fig:rules:utxo-shelley}
\end{figure*}
</a></pre></body></html>