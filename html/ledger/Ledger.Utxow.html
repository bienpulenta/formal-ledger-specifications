<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Utxow</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\subsection{Witnessing}
</a><a id="25" class="Markup">\begin{code}[hide]</a>
<a id="44" class="Symbol">{-#</a> <a id="48" class="Keyword">OPTIONS</a> <a id="56" class="Pragma">--safe</a> <a id="63" class="Symbol">#-}</a>

<a id="68" class="Keyword">open</a> <a id="73" class="Keyword">import</a> <a id="80" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>

<a id="100" class="Keyword">module</a> <a id="107" href="Ledger.Utxow.html" class="Module">Ledger.Utxow</a> <a id="120" class="Symbol">(</a><a id="121" href="Ledger.Utxow.html#121" class="Bound">txs</a> <a id="125" class="Symbol">:</a> <a id="127" href="Ledger.Transaction.html#516" class="Record">TransactionStructure</a><a id="147" class="Symbol">)</a> <a id="149" class="Keyword">where</a>

<a id="156" class="Keyword">open</a> <a id="161" class="Keyword">import</a> <a id="168" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a>

<a id="184" class="Keyword">import</a> <a id="191" href="Data.Maybe.html" class="Module">Data.Maybe</a> <a id="202" class="Symbol">as</a> <a id="205" class="Module">M</a>
<a id="207" class="Keyword">import</a> <a id="214" href="Data.Nat.html" class="Module">Data.Nat</a>

<a id="224" class="Keyword">open</a> <a id="229" href="Ledger.Transaction.html#516" class="Module">TransactionStructure</a> <a id="250" href="Ledger.Utxow.html#121" class="Bound">txs</a>
<a id="254" class="Keyword">open</a> <a id="259" class="Keyword">import</a> <a id="266" href="Ledger.Crypto.html" class="Module">Ledger.Crypto</a>
<a id="280" class="Keyword">open</a> <a id="285" class="Keyword">import</a> <a id="292" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="304" href="Ledger.Utxow.html#121" class="Bound">txs</a>

<a id="309" class="Keyword">open</a> <a id="314" href="Ledger.Transaction.html#3201" class="Module">TxBody</a>
<a id="321" class="Keyword">open</a> <a id="326" href="Ledger.Transaction.html#3622" class="Module">TxWitnesses</a>
<a id="338" class="Keyword">open</a> <a id="343" href="Ledger.Transaction.html#3718" class="Module">Tx</a>
<a id="346" class="Markup">\end{code}</a><a id="356" class="Background">

\begin{figure*}[h]
</a><a id="377" class="Markup">\begin{code}</a>
<a id="witsVKeyNeeded"></a><a id="390" href="Ledger.Utxow.html#390" class="Function">witsVKeyNeeded</a> <a id="405" class="Symbol">:</a> <a id="407" href="Ledger.Transaction.html#2861" class="Function">UTxO</a> <a id="412" class="Symbol">→</a> <a id="414" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="421" class="Symbol">→</a> <a id="423" href="Ledger.Prelude.html#1236" class="Function Operator">ℙ</a> <a id="425" href="Ledger.Crypto.html#1812" class="Function">KeyHash</a>
<a id="433" href="Ledger.Utxow.html#390" class="Function">witsVKeyNeeded</a> <a id="448" href="Ledger.Utxow.html#448" class="Bound">utxo</a> <a id="453" href="Ledger.Utxow.html#453" class="Bound">txb</a> <a id="457" class="Symbol">=</a>
  <a id="461" href="Axiom.Set.html#4480" class="Function">mapPartial</a> <a id="472" class="Symbol">((λ</a> <a id="476" class="Symbol">{</a> <a id="478" class="Symbol">(</a><a id="479" href="Data.Sum.Base.html#666" class="InductiveConstructor">inj₁</a> <a id="484" href="Ledger.Utxow.html#484" class="Bound">kh</a><a id="486" class="Symbol">)</a> <a id="488" class="Symbol">→</a> <a id="490" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="495" href="Ledger.Utxow.html#484" class="Bound">kh</a> <a id="498" class="Symbol">;</a> <a id="500" class="CatchallClause Symbol">_</a> <a id="502" class="Symbol">→</a> <a id="504" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="512" class="Symbol">})</a> <a id="515" href="Function.Base.html#1106" class="Function Operator">∘</a> <a id="517" href="Ledger.Address.html#1883" class="Function">payCred</a> <a id="525" href="Function.Base.html#1106" class="Function Operator">∘</a> <a id="527" href="Data.Product.Base.html#608" class="Field">proj₁</a><a id="532" class="Symbol">)</a> <a id="534" class="Symbol">((</a><a id="536" href="Ledger.Utxow.html#448" class="Bound">utxo</a> <a id="541" href="Axiom.Set.Map.html#1686" class="Function Operator">ˢ</a><a id="542" class="Symbol">)</a> <a id="544" href="Axiom.Set.Rel.html#1907" class="Function Operator">⟪$⟫</a> <a id="548" href="Ledger.Transaction.html#3230" class="Field">txins</a> <a id="554" href="Ledger.Utxow.html#453" class="Bound">txb</a><a id="557" class="Symbol">)</a>

<a id="scriptsNeeded"></a><a id="560" href="Ledger.Utxow.html#560" class="Function">scriptsNeeded</a> <a id="574" class="Symbol">:</a> <a id="576" href="Ledger.Transaction.html#2861" class="Function">UTxO</a> <a id="581" class="Symbol">→</a> <a id="583" href="Ledger.Transaction.html#3201" class="Record">TxBody</a> <a id="590" class="Symbol">→</a> <a id="592" href="Ledger.Prelude.html#1236" class="Function Operator">ℙ</a> <a id="594" href="Ledger.Crypto.html#1750" class="Function">ScriptHash</a>
<a id="605" href="Ledger.Utxow.html#560" class="Function">scriptsNeeded</a> <a id="619" href="Ledger.Utxow.html#619" class="Bound">utxo</a> <a id="624" href="Ledger.Utxow.html#624" class="Bound">txb</a> <a id="628" class="Symbol">=</a>
  <a id="632" href="Axiom.Set.html#4480" class="Function">mapPartial</a> <a id="643" class="Symbol">((λ</a> <a id="647" class="Symbol">{</a> <a id="649" class="Symbol">(</a><a id="650" href="Data.Sum.Base.html#691" class="InductiveConstructor">inj₂</a> <a id="655" href="Ledger.Utxow.html#655" class="Bound">sh</a><a id="657" class="Symbol">)</a> <a id="659" class="Symbol">→</a> <a id="661" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="666" href="Ledger.Utxow.html#655" class="Bound">sh</a> <a id="669" class="Symbol">;</a> <a id="671" class="CatchallClause Symbol">_</a> <a id="673" class="Symbol">→</a> <a id="675" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="683" class="Symbol">})</a> <a id="686" href="Function.Base.html#1106" class="Function Operator">∘</a> <a id="688" href="Ledger.Address.html#1883" class="Function">payCred</a> <a id="696" href="Function.Base.html#1106" class="Function Operator">∘</a> <a id="698" href="Data.Product.Base.html#608" class="Field">proj₁</a><a id="703" class="Symbol">)</a> <a id="705" class="Symbol">((</a><a id="707" href="Ledger.Utxow.html#619" class="Bound">utxo</a> <a id="712" href="Axiom.Set.Map.html#1686" class="Function Operator">ˢ</a><a id="713" class="Symbol">)</a> <a id="715" href="Axiom.Set.Rel.html#1907" class="Function Operator">⟪$⟫</a> <a id="719" href="Ledger.Transaction.html#3230" class="Field">txins</a> <a id="725" href="Ledger.Utxow.html#624" class="Bound">txb</a><a id="728" class="Symbol">)</a>

<a id="scriptsP1"></a><a id="731" href="Ledger.Utxow.html#731" class="Function">scriptsP1</a> <a id="741" class="Symbol">:</a> <a id="743" href="Ledger.Transaction.html#3622" class="Record">TxWitnesses</a> <a id="755" class="Symbol">→</a> <a id="757" href="Ledger.Prelude.html#1236" class="Function Operator">ℙ</a> <a id="759" href="Ledger.Script.html#471" class="Function">P1Script</a>
<a id="768" href="Ledger.Utxow.html#731" class="Function">scriptsP1</a> <a id="778" href="Ledger.Utxow.html#778" class="Bound">txw</a> <a id="782" class="Symbol">=</a> <a id="784" href="Axiom.Set.html#4480" class="Function">mapPartial</a> <a id="795" class="Symbol">(λ</a> <a id="798" class="Symbol">{</a> <a id="800" class="Symbol">(</a><a id="801" href="Data.Sum.Base.html#666" class="InductiveConstructor">inj₁</a> <a id="806" href="Ledger.Utxow.html#806" class="Bound">s</a><a id="807" class="Symbol">)</a> <a id="809" class="Symbol">→</a> <a id="811" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="816" href="Ledger.Utxow.html#806" class="Bound">s</a> <a id="818" class="Symbol">;</a> <a id="820" class="CatchallClause Symbol">_</a> <a id="822" class="Symbol">→</a> <a id="824" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="832" class="Symbol">})</a> <a id="835" class="Symbol">(</a><a id="836" href="Ledger.Transaction.html#3688" class="Field">scripts</a> <a id="844" href="Ledger.Utxow.html#778" class="Bound">txw</a><a id="847" class="Symbol">)</a>
<a id="849" class="Markup">\end{code}</a><a id="859" class="Background">
\caption{Functions used for witnessing}
\label{fig:functions:utxow}
\end{figure*}

\begin{figure*}[h]
</a><a id="962" class="Markup">\begin{code}[hide]</a>
<a id="981" class="Keyword">data</a>
<a id="986" class="Markup">\end{code}</a><a id="996" class="Background">
</a><a id="997" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,UTXOW⦈_"></a><a id="1012" href="Ledger.Utxow.html#1012" class="Datatype Operator">_⊢_⇀⦇_,UTXOW⦈_</a> <a id="1027" class="Symbol">:</a> <a id="1029" href="Ledger.Utxo.html#3359" class="Record">UTxOEnv</a> <a id="1037" class="Symbol">→</a> <a id="1039" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a> <a id="1049" class="Symbol">→</a> <a id="1051" href="Ledger.Transaction.html#3718" class="Record">Tx</a> <a id="1054" class="Symbol">→</a> <a id="1056" href="Ledger.Utxo.html#3478" class="Record">UTxOState</a> <a id="1066" class="Symbol">→</a> <a id="1068" href="Agda.Primitive.html#320" class="Primitive">Set</a>
<a id="1072" class="Markup">\end{code}</a><a id="1082" class="Background">
\caption{UTxOW transition-system types}
\label{fig:ts-types:utxow}
\end{figure*}

\begin{figure*}[h]
</a><a id="1184" class="Markup">\begin{code}[hide]</a>
<a id="1203" class="Keyword">data</a> <a id="1208" href="Ledger.Utxow.html#1012" class="Datatype Operator">_⊢_⇀⦇_,UTXOW⦈_</a> <a id="1223" class="Keyword">where</a>
<a id="1229" class="Markup">\end{code}</a><a id="1239" class="Background">
</a><a id="1240" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,UTXOW⦈_.UTXOW-inductive"></a><a id="1255" href="Ledger.Utxow.html#1255" class="InductiveConstructor">UTXOW-inductive</a> <a id="1271" class="Symbol">:</a>
    <a id="1277" class="Symbol">∀</a> <a id="1279" class="Symbol">{</a><a id="1280" href="Ledger.Utxow.html#1280" class="Bound">Γ</a><a id="1281" class="Symbol">}</a> <a id="1283" class="Symbol">{</a><a id="1284" href="Ledger.Utxow.html#1284" class="Bound">s</a><a id="1285" class="Symbol">}</a> <a id="1287" class="Symbol">{</a><a id="1288" href="Ledger.Utxow.html#1288" class="Bound">tx</a><a id="1290" class="Symbol">}</a> <a id="1292" class="Symbol">{</a><a id="1293" href="Ledger.Utxow.html#1293" class="Bound">s&#39;</a><a id="1295" class="Symbol">}</a>
    <a id="1301" class="Symbol">→</a> <a id="1303" class="Keyword">let</a> <a id="1307" href="Ledger.Utxow.html#1307" class="Bound">utxo</a> <a id="1312" class="Symbol">=</a> <a id="1314" href="Ledger.Utxo.html#3529" class="Field">UTxOState.utxo</a> <a id="1329" href="Ledger.Utxow.html#1284" class="Bound">s</a>
          <a id="1341" href="Ledger.Utxow.html#1341" class="Bound">txb</a> <a id="1345" class="Symbol">=</a> <a id="1347" href="Ledger.Transaction.html#3743" class="Field">body</a> <a id="1352" href="Ledger.Utxow.html#1288" class="Bound">tx</a>
          <a id="1365" href="Ledger.Utxow.html#1365" class="Bound">txw</a> <a id="1369" class="Symbol">=</a> <a id="1371" href="Ledger.Transaction.html#3768" class="Field">wits</a> <a id="1376" href="Ledger.Utxow.html#1288" class="Bound">tx</a>
          <a id="1389" href="Ledger.Utxow.html#1389" class="Bound">witsKeyHashes</a> <a id="1403" class="Symbol">=</a> <a id="1405" href="Axiom.Set.html#3677" class="Function">map</a> <a id="1409" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="1414" class="Symbol">(</a><a id="1415" href="Axiom.Set.Rel.html#1257" class="Function">dom</a> <a id="1419" class="Symbol">(</a><a id="1420" href="Ledger.Transaction.html#3656" class="Field">vkSigs</a> <a id="1427" href="Ledger.Utxow.html#1365" class="Bound">txw</a> <a id="1431" href="Axiom.Set.Map.html#1686" class="Function Operator">ˢ</a><a id="1432" class="Symbol">))</a>
          <a id="1445" href="Ledger.Utxow.html#1445" class="Bound">witsScriptHashes</a> <a id="1462" class="Symbol">=</a> <a id="1464" href="Axiom.Set.html#3677" class="Function">map</a> <a id="1468" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="1473" class="Symbol">(</a><a id="1474" href="Ledger.Transaction.html#3688" class="Field">scripts</a> <a id="1482" href="Ledger.Utxow.html#1365" class="Bound">txw</a><a id="1485" class="Symbol">)</a>
      <a id="1493" class="Keyword">in</a>
    <a id="1500" href="Axiom.Set.html#5743" class="Function">All</a> <a id="1504" class="Symbol">(λ</a> <a id="1507" class="Keyword">where</a> <a id="1513" class="Symbol">(</a><a id="1514" href="Ledger.Utxow.html#1514" class="Bound">vk</a> <a id="1517" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="1519" href="Ledger.Utxow.html#1519" class="Bound">σ</a><a id="1520" class="Symbol">)</a> <a id="1522" class="Symbol">→</a> <a id="1524" href="Ledger.Crypto.html#994" class="Function">isSigned</a> <a id="1533" href="Ledger.Utxow.html#1514" class="Bound">vk</a> <a id="1536" class="Symbol">(</a><a id="1537" href="Ledger.Transaction.html#1883" class="Field">txidBytes</a> <a id="1547" class="Symbol">(</a><a id="1548" href="Ledger.Transaction.html#3594" class="Field">txid</a> <a id="1553" href="Ledger.Utxow.html#1341" class="Bound">txb</a><a id="1556" class="Symbol">))</a> <a id="1559" href="Ledger.Utxow.html#1519" class="Bound">σ</a><a id="1560" class="Symbol">)</a> <a id="1562" class="Symbol">(</a><a id="1563" href="Ledger.Transaction.html#3656" class="Field">vkSigs</a> <a id="1570" href="Ledger.Utxow.html#1365" class="Bound">txw</a> <a id="1574" href="Axiom.Set.Map.html#1686" class="Function Operator">ˢ</a><a id="1575" class="Symbol">)</a>
    <a id="1581" class="Symbol">→</a> <a id="1583" href="Axiom.Set.html#5743" class="Function">All</a> <a id="1587" class="Symbol">(</a><a id="1588" href="Ledger.Script.html#494" class="Function">validP1Script</a> <a id="1602" href="Ledger.Utxow.html#1389" class="Bound">witsKeyHashes</a> <a id="1616" class="Symbol">(</a><a id="1617" href="Ledger.Transaction.html#3385" class="Field">txvldt</a> <a id="1624" href="Ledger.Utxow.html#1341" class="Bound">txb</a><a id="1627" class="Symbol">))</a> <a id="1630" class="Symbol">(</a><a id="1631" href="Ledger.Utxow.html#731" class="Function">scriptsP1</a> <a id="1641" href="Ledger.Utxow.html#1365" class="Bound">txw</a><a id="1644" class="Symbol">)</a>
    <a id="1650" class="Symbol">→</a> <a id="1652" href="Ledger.Utxow.html#390" class="Function">witsVKeyNeeded</a> <a id="1667" href="Ledger.Utxow.html#1307" class="Bound">utxo</a> <a id="1672" href="Ledger.Utxow.html#1341" class="Bound">txb</a> <a id="1676" href="Axiom.Set.html#1579" class="Function Operator">⊆</a> <a id="1678" href="Ledger.Utxow.html#1389" class="Bound">witsKeyHashes</a>
    <a id="1696" class="Symbol">→</a> <a id="1698" href="Ledger.Utxow.html#560" class="Function">scriptsNeeded</a> <a id="1712" href="Ledger.Utxow.html#1307" class="Bound">utxo</a> <a id="1717" href="Ledger.Utxow.html#1341" class="Bound">txb</a> <a id="1721" href="Axiom.Set.html#2238" class="Function Operator">≡ᵉ</a> <a id="1724" href="Ledger.Utxow.html#1445" class="Bound">witsScriptHashes</a>
    <a id="1745" class="Comment">-- TODO: check genesis signatures</a>
    <a id="1783" class="Symbol">→</a> <a id="1785" href="Ledger.Transaction.html#3496" class="Field">txADhash</a> <a id="1794" href="Ledger.Utxow.html#1341" class="Bound">txb</a> <a id="1798" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="1800" href="Data.Maybe.Base.html#2035" class="Function">M.map</a> <a id="1806" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="1811" class="Symbol">(</a><a id="1812" href="Ledger.Transaction.html#3798" class="Field">txAD</a> <a id="1817" href="Ledger.Utxow.html#1288" class="Bound">tx</a><a id="1819" class="Symbol">)</a>
    <a id="1825" class="Symbol">→</a> <a id="1827" href="Ledger.Utxow.html#1280" class="Bound">Γ</a> <a id="1829" href="Ledger.Utxo.html#5066" class="Datatype Operator">⊢</a> <a id="1831" href="Ledger.Utxow.html#1284" class="Bound">s</a> <a id="1833" href="Ledger.Utxo.html#5066" class="Datatype Operator">⇀⦇</a> <a id="1836" href="Ledger.Utxow.html#1341" class="Bound">txb</a> <a id="1840" href="Ledger.Utxo.html#5066" class="Datatype Operator">,UTXO⦈</a> <a id="1847" href="Ledger.Utxow.html#1293" class="Bound">s&#39;</a>
    <a id="1854" href="Interface.ComputationalRelation.html#276" class="Function Operator">────────────────────────────────</a>
    <a id="1891" href="Ledger.Utxow.html#1280" class="Bound">Γ</a> <a id="1893" href="Ledger.Utxow.html#1012" class="Datatype Operator">⊢</a> <a id="1895" href="Ledger.Utxow.html#1284" class="Bound">s</a> <a id="1897" href="Ledger.Utxow.html#1012" class="Datatype Operator">⇀⦇</a> <a id="1900" href="Ledger.Utxow.html#1288" class="Bound">tx</a> <a id="1903" href="Ledger.Utxow.html#1012" class="Datatype Operator">,UTXOW⦈</a> <a id="1911" href="Ledger.Utxow.html#1293" class="Bound">s&#39;</a>
<a id="1914" class="Markup">\end{code}</a><a id="1924" class="Background">
\caption{UTXOW inference rules}
\label{fig:rules:utxow}
\end{figure*}
</a></pre></body></html>